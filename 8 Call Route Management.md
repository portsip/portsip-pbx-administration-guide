# 8 呼叫路由管理

外呼和接入规则决定了PortSIP PBX如何根据某些标准来路由呼叫。你可以配置规则来控制呼叫通过哪条中继线，例如，根据最低成本路由，将呼叫通过你的中继线。

你也可以设置DID（直接向内拨号）号码，让你绕过接待员或IVR，直接把电话打到用户的分机上。

## 8.1 创建接入规则

许多公司为用户和/或部门提供 "直接或DID号码"，允许他们的联系人绕过接待员，直接拨打电话。DID号码在英国也被称为DDI号码，在德国被称为MSN号码。

即使你使用了虚拟接待员，直拨电话或号码往往是最好的，因为它对来电者来说更方便。

直拨号码可以通过使用 "呼入规则 "轻松实现。DID号码是由你的中继供应商或电话公司提供的，是分配给你的物理线路的虚拟号码。通常情况下，你会被分配到一系列的号码。请向您的电话公司或中继线供应商了解更多关于DID号码的信息。

在添加入站规则之前，你必须至少配置一条中继线。

要添加入站规则：

1.以 "系统管理员 "的身份登录 PortSIP PBX 门户网站，点击菜单 "租户"，选择一个租户，然后点击 "管理 "按钮来管理这个租户，配置呼入规则。 或者将一个有租户管理员权限的用户登录到门户网站，管理这个租户。

2.从门户网站，选择 "呼叫管理器 > 呼入规则"，并点击 "添加 "按钮。

3.为该规则输入一个友好的名称

4.CID号码掩码：你可以在这里输入CID号码掩码，PBX会用它来识别来电者。你可以添加号码的全部内容，识别单个来电者，或者使用*作为通配符。例如，0044********** 将识别一个英国来电者，004420******** 将识别一个来自伦敦的来电者。注意：*号数字必须与数字实际相符。如果号码是3位数，那么应该使用***。

  + CID号码掩码也允许设置为一个号码范围，例如 
    00442012345670-00442012345680.

  + CID号码掩码可以是空的

5.在中继箱中，选择你希望与此DID和呼入规则相关联的中继，只允许在呼入规则中指定一个供应商。

6.在 "DID/DDI号码掩码 "区域，输入DID号码，因为它将出现在SIP的 "To "标题中（你的中继供应商已经应用了你的主号码，或第一个DID号码）。PortSIP PBX 将把这个号码与中继线发送给 PBX 的 SIP INVITE 消息的 "到 "字头相匹配。

  + DID号码可以是一个单一的数字，如442012345678
  + DID号码可以是序列号范围，例如。3325261000-3325262000，442012345600-442012345800 .
  + 单个DID号码或序列号范围必须在中继DID池范围内。
  + DID号码和DID池不能以 "+"、"0 "或 "00 "开头；如果您的DID号码或DID池以 "+"、"0 "或 "00 "开头，请在输入前删除。

7.指定你希望根据此呼入规则转接来电的方式。

  + 转发到号码：允许你输入一个号码，然后将呼叫转发到该号码；该号码可以是分机号码或系统分机号码（铃声组、虚拟接待员、会议号码、队列号码）或PSTN电话号码。该号码也可以是一个范围，例如：2000-3000。如果将 "转发号码 "字段设置为一个范围，这个范围必须是序列号，"DID号码掩码 "也必须是一个号码范围，并且两个范围大小必须相等。例如，在 "DID号码掩码 "字段中填入442012345600-442012345800，在 "转接号码 "字段中设置为1100-1300，如果从中继线打来的电话是442012345600，PBX将把这个电话转到分机1100；如果从中继线打来的电话是442012345698，PBX将把这个电话转到分机1198，这就是1：1映射。
  + 转发到语音信箱。呼叫将被路由到语音信箱服务，以便呼叫者可以留下语音信息。有一个选项可以为语音信箱选择一个分机号码。例如，如果你选择分机108，语音邮件将被保存在108的邮箱里。
  + 挂断。呼叫将由PBX终止。

8.你可以指定，如果一个来电是在办公时间以外收到的，应该以不同的方式进行转接。

9.你可以设置一个呼入规则，将大量的DID号码转到大量的分机上。见上面第7点。

## 8.2 接入规则的工作时间

在 "办公时间 "页面，你可以为呼入规则设置办公时间，这样呼入的电话就会根据当前的时间被转接到不同的目的地。

如果选择了 "使用默认的全球办公时间"，PBX 将使用租户管理部门指定的办公时间。

如果选择了 "使用特定的办公时间"，则会采用自定义的办公时间规则。

## 8.3 高级主题: 路由

你可以根据同一DID号码在一条中继线上创建多个呼入规则，但所有这些呼入规则必须有不同的CID号码掩码。

例如。你有DID 00442012345670。创建两个呼入规则：第一个规则的CID是0044**********，DID号码掩码是442012345670，呼叫被路由到 "队列8000"；第二个规则的CID是0033*********，DID号码掩码是442012345670，呼叫被路由到 "队列9000"。

现在让所有讲英语的员工成为 "队列8000 "的代理，并让所有讲法语的员工成为 "队列9000 "的代理。当呼叫者拨打 "00442012345670 "时，来自英国的呼叫者将被转到呼叫队列8000，与英语代理交谈，而来自法国的呼叫者将被转到呼叫队列9000，与法语代理交谈。

## 8.4 高级主题：将批量号码路由至批量分机

假设一个拥有1000名员工的大公司，从中继服务提供商那里购买了1000个DID号码，这些DID号码中使用了序列号。如果你给每个员工分配一个DID号码，你的客户可以通过拨打他们的DID号码来联系他们。然而，这是一个几乎很难的分配，因为必须创建1,000个入站规则，将1,000个DID号码路由到1,000个分机（每个雇员是一个分机）。

PortSIP PBX有一个很好的功能，可以让你只用一条呼入规则就能实现你的目标。

假设DID号码是 "0012012345001-0012012346000"，而员工的分机号码是 "1001-2000"。

1.创建一个呼入规则，并将 "DID号码掩码 "字段设置为 "12012345001-12012346000"。

2.将呼叫路由目的地设置为 "1001-2000"

如果有人拨打 "0012012345001"，电话将被转到分机 "1001"，如果拨打 "0012012345005"，电话将被转到分机 "1005"。

![8-1.png](v16/images/8-1.png)

## 8.5 创建外拨规则

呼出规则决定了呼出电话将通过哪条中继线被放置。该规则由拨打电话的用户/分机、正在拨打的号码、号码的长度、或呼叫者所属的用户组决定。

要添加呼出规则。

  + 从 PortSIP PBX Web Portal 菜单中，导航到 "Call Manager > Outbound Rules" 并点击 "Add "按钮。在字段中输入一个新规则的名称。

  + 优先级：设置呼出规则的优先级。如果一个电话符合多个呼出规则，优先级较低的号码具有较高的优先级。

  + 指定触发此呼出规则所应匹配的标准。在 "将此规则应用于以下呼叫 "部分，指定以下任何选项。

    + 对以前缀开始的号码的呼叫。将此规则应用于所有以你指定的号码开始的呼叫。例如，输入 "00 "来指定所有以00开头的号码的呼叫都应触发此规则。呼叫者应该拨打 "00xxx "来触发这个规则。你可以指定一个以上的前缀，用"；"分隔。例如，"00;123;88 "指定了前缀 "00 "和 "123 "以及 "88"。如果被叫号码与这些前缀之一相匹配，这个规则将被触发。

    + 来自分机的呼叫。选择这个选项来定义一个特定的分机或分机范围，这个规则适用于该分机。指定一个或多个分机，用分号隔开，或者用"-"来指定一个范围。例如，100-120。

    + 呼叫带有某些数字的号码。选择此选项，将规则应用于具有特定数字长度的号码，例如8位数字。通过这种方法，你可以捕捉到不需要前缀的本地区域号码或国家号码的呼叫。

    + 来自分机组的呼叫：你可以选择一个用户组，而不是指定个别分机。

  + 现在指定如何用标准来匹配呼出电话。在 "呼出电话 "部分，可以选择最多三条通话路线。每个定义的中继线都会被列为可能的路由。如果第一条路由不可用或者繁忙，PortSIP PBX将自动尝试第二条路由。你可以拖放路由来调整优先级。

  + 你可以通过使用 "Strip Digits "和 "Prepend "字段，在呼叫被路由到选定的网关或供应商之前，改变符合呼出规则的号码。

    + 剥离数字。这允许你从被叫号码中删除一个或多个数字。如果不需要的话，使用该选项在呼叫拨到中继站或供应商之前删除前缀。例如，如果分机拨打002345，如果你指定要删除两个数字，那么在路由之前，前缀 "00 "将被删除。

    + 前缀：如果供应商或网关要求，这允许你在号码的开头添加一个或多个数字。例如，如果分机拨打002345，我们在 "删除数字 "栏中指定2，并将 "预置 "设置为 "+44"，那么PBX转发给VoIP提供商/SIP Trunk的最终被叫号码将是+442345。

## 8.6 外拨规则的工作时间

在 "办公时间 "页面，你可以为呼出规则设置办公时间，这样呼出的电话就会根据当前的时间被转接到中继站或不被转接。

例如，如果当前时间不在指定的办公时间内，即使呼出规则被成功匹配，呼叫也会失败。

如果选择 "使用默认的全球办公时间"，PBX 将使用 "租户管理 "设置的办公时间。 如果选择 "使用特定的办公时间"，此呼出规则将使用自定义的办公时间。








































































